name: CI - Code Quality & Tests

on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master

jobs:
  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: '1.2'

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run linting (Ultracite)
        run: npx ultracite check
        continue-on-error: true

      - name: Run type checking
        run: bun run check-types

  # e2e-tests:
  #   name: E2E Tests
  #   runs-on: ubuntu-latest
  #   needs: lint-and-typecheck
  #
  #   services:
  #     postgres:
  #       image: postgres:17-alpine
  #       env:
  #         POSTGRES_PASSWORD: testpassword
  #         POSTGRES_USER: testuser
  #         POSTGRES_DB: testdb
  #       options: >-
  #         --health-cmd pg_isready
  #         --health-interval 10s
  #         --health-timeout 5s
  #         --health-retries 5
  #       ports:
  #         - 5432:5432
  #
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Bun
  #       uses: oven-sh/setup-bun@v1
  #       with:
  #         bun-version: '1.2'
  #
  #     - name: Install dependencies
  #       run: bun install --frozen-lockfile
  #
  #     - name: Install Playwright browsers
  #       run: bunx playwright install --with-deps chromium
  #
  #     - name: Setup test environment
  #       env:
  #         DATABASE_URL: postgresql://testuser:testpassword@localhost:5432/testdb
  #         BETTER_AUTH_SECRET: test-secret-for-ci-testing-only
  #         BETTER_AUTH_URL: http://localhost:3000
  #         CORS_ORIGIN: http://localhost:3001
  #         VITE_SERVER_URL: http://localhost:3000
  #       run: |
  #         # Run database migrations
  #         bun run db:push
  #
  #     - name: Run E2E tests
  #       env:
  #         DATABASE_URL: postgresql://testuser:testpassword@localhost:5432/testdb
  #         BETTER_AUTH_SECRET: test-secret-for-ci-testing-only
  #         BETTER_AUTH_URL: http://localhost:3000
  #         CORS_ORIGIN: http://localhost:3001
  #         VITE_SERVER_URL: http://localhost:3000
  #       run: bun run test:e2e
  #
  #     - name: Upload test results
  #       uses: actions/upload-artifact@v4
  #       if: always()
  #       with:
  #         name: playwright-report
  #         path: apps/web/playwright-report/
  #         retention-days: 30

  build-verification:
    name: Verify Docker Build
    runs-on: ubuntu-latest
    needs: lint-and-typecheck

    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: synergy_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (verification only)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: false
          load: true
          tags: gk-nexus:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VITE_SERVER_URL=http://localhost:3000

      - name: Verify image was built
        run: |
          echo "Verifying Docker image..."
          docker images | grep gk-nexus

          # Check image size
          SIZE=$(docker images gk-nexus:test --format "{{.Size}}")
          echo "✅ Image built successfully: $SIZE"

          # Verify it's under 300MB target
          SIZE_MB=$(docker images gk-nexus:test --format "{{.Size}}" | sed 's/MB//')
          if [ $(echo "$SIZE_MB < 300" | bc) -eq 1 ]; then
            echo "✅ Image size ($SIZE_MB MB) is under 300MB target"
          else
            echo "⚠️ Warning: Image size ($SIZE_MB MB) exceeds 300MB target"
          fi

      - name: Setup Bun for migrations
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: '1.2'

      - name: Install dependencies for migrations
        run: bun install --frozen-lockfile

      - name: Push database schema
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/synergy_test
        working-directory: packages/db
        run: bunx drizzle-kit push

      - name: Start container for health check
        run: |
          # Use --network host on Linux CI to access the PostgreSQL service on localhost
          docker run -d --name gk-nexus-test \
            --network host \
            -e DATABASE_URL=postgresql://postgres:postgres@localhost:5432/synergy_test \
            -e BETTER_AUTH_SECRET=test-secret-for-ci-verification-only-minimum-32-chars \
            -e BETTER_AUTH_URL=http://localhost:3000 \
            -e CORS_ORIGIN=http://localhost:3001 \
            gk-nexus:test

      - name: Wait for application startup
        run: |
          echo "Waiting for application to become healthy..."
          max_attempts=60
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            if docker exec gk-nexus-test curl -f http://localhost:3000/health 2>/dev/null; then
              echo "✅ Health check passed!"
              break
            fi

            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts - waiting 1s..."
            sleep 1
          done

          if [ $attempt -eq $max_attempts ]; then
            echo "❌ Health check failed after ${max_attempts}s"
            echo "Container logs:"
            docker logs gk-nexus-test
            exit 1
          fi

      - name: Verify application endpoints
        run: |
          echo "Testing health endpoint..."
          HEALTH_STATUS=$(docker exec gk-nexus-test curl -s http://localhost:3000/health)
          echo "Health response: $HEALTH_STATUS"

          if echo "$HEALTH_STATUS" | grep -q "healthy"; then
            echo "✅ Health endpoint check passed"
          else
            echo "❌ Health endpoint check failed"
            docker logs gk-nexus-test
            exit 1
          fi

          echo "Testing root endpoint..."
          HTTP_CODE=$(docker exec gk-nexus-test curl -s -o /dev/null -w '%{http_code}' http://localhost:3000/)
          echo "Root endpoint HTTP code: $HTTP_CODE"

          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "404" ]; then
            echo "✅ Root endpoint check passed"
          else
            echo "❌ Root endpoint returned unexpected code: $HTTP_CODE"
            docker logs gk-nexus-test
            exit 1
          fi

          echo "✅ All endpoint checks passed!"

      - name: Cleanup test container
        if: always()
        run: |
          docker stop gk-nexus-test || true
          docker rm gk-nexus-test || true
