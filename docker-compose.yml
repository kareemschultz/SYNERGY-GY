# =============================================================================
# GK-Nexus Docker Compose Configuration
# =============================================================================
# Production-ready Docker Compose setup following LinuxServer.io best practices
#
# SIMPLE SETUP (linuxserver.io style):
#   1. cp .env.example .env
#   2. Edit .env with your values (generate secrets with openssl rand -base64 32)
#   3. IMPORTANT: Ensure DATABASE_URL password matches POSTGRES_PASSWORD
#   4. docker compose up -d
#   5. curl http://localhost:3000/health
#
# NOTE: Docker Compose automatically reads the .env file for variable substitution.
# All ${VAR:-default} values below are read from your .env file.
#
# Security:
#   - Non-root containers
#   - Read-only filesystems
#   - Dropped capabilities
#   - no-new-privileges
#   - Health checks
#   - Named volumes for data persistence
#
# Docs: See docs/DOCKER_DEPLOYMENT.md
# =============================================================================

services:
  # ===========================================================================
  # PostgreSQL Database
  # ===========================================================================
  postgres:
    image: postgres:17-alpine
    container_name: gk-nexus-postgres
    restart: unless-stopped

    environment:
      POSTGRES_USER: ${POSTGRES_USER:-gknexus}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-gknexus_dev_password}
      POSTGRES_DB: ${POSTGRES_DB:-gknexus}

    ports:
      - "${POSTGRES_PORT:-5432}:5432"

    volumes:
      - postgres_data:/var/lib/postgresql/data

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-gknexus}"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

    # Security hardening
    security_opt:
      - no-new-privileges:true

    networks:
      - gk-nexus

  # ===========================================================================
  # GK-Nexus Application Server (Bundled - 128MB)
  # ===========================================================================
  server:
    # Pull pre-built image from GitHub Container Registry
    image: ghcr.io/kareemschultz/gk-nexus:latest
    container_name: gk-nexus-server
    restart: unless-stopped

    depends_on:
      postgres:
        condition: service_healthy

    environment:
      # Database
      DATABASE_URL: ${DATABASE_URL:-postgresql://gknexus:gknexus_dev_password@postgres:5432/gknexus}

      # Authentication (REQUIRED - generate with: openssl rand -base64 32)
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET}
      BETTER_AUTH_URL: ${BETTER_AUTH_URL:-http://localhost:3000}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3001}

      # Application
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${PORT:-3000}

      # Initial Admin (REQUIRED for first run)
      INITIAL_OWNER_EMAIL: ${INITIAL_OWNER_EMAIL}
      INITIAL_OWNER_PASSWORD: ${INITIAL_OWNER_PASSWORD}
      INITIAL_OWNER_NAME: ${INITIAL_OWNER_NAME:-Administrator}

      # Email (Optional)
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      EMAIL_FROM: ${EMAIL_FROM:-}

      # Cloud Backup (Optional)
      BACKUP_S3_ENDPOINT: ${BACKUP_S3_ENDPOINT:-}
      BACKUP_S3_ACCESS_KEY_ID: ${BACKUP_S3_ACCESS_KEY_ID:-}
      BACKUP_S3_SECRET_ACCESS_KEY: ${BACKUP_S3_SECRET_ACCESS_KEY:-}
      BACKUP_S3_BUCKET: ${BACKUP_S3_BUCKET:-gk-nexus-backups}
      BACKUP_S3_REGION: ${BACKUP_S3_REGION:-auto}

    ports:
      # External:Internal port mapping
      # Set APP_PORT in .env to change external port (e.g., APP_PORT=8843 for Pangolin)
      # Internal port always 3000 (do not change)
      - "${APP_PORT:-3000}:3000"

    # Persistent volumes (LinuxServer.io style)
    volumes:
      - uploads:/app/data/uploads
      - backups:/app/backups

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    # Security hardening (LinuxServer.io best practices)
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=100m
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE

    networks:
      - gk-nexus

# =============================================================================
# Named Volumes (Data Persistence)
# =============================================================================
volumes:
  postgres_data:
    name: gk-nexus-postgres-data
    driver: local

  uploads:
    name: gk-nexus-uploads
    driver: local

  backups:
    name: gk-nexus-backups
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  gk-nexus:
    driver: bridge
